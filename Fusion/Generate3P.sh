#!/bin/bash
export SDKARTIFACT=build/fusion3p

export LOCATION="build"

function failed {
  echo "$1" 1>&2
  exit 1;
}

echo Clean artifacts-folder $SDKARTIFACT
rm -rf $SDKARTIFACT
mkdir $SDKARTIFACT

mkdir $SDKARTIFACT/win64_0
mkdir $SDKARTIFACT/win64_0/headers
mkdir $SDKARTIFACT/win64_0/libs
mkdir $SDKARTIFACT/win64_0/libs/Debug
mkdir $SDKARTIFACT/win64_0/libs/Release
mkdir $SDKARTIFACT/win64_0/runtimeroots
mkdir $SDKARTIFACT/win64_0/runtimeroots/Release

mkdir $SDKARTIFACT/mac64_0
mkdir $SDKARTIFACT/mac64_0/headers
mkdir $SDKARTIFACT/mac64_0/libs
mkdir $SDKARTIFACT/mac64_0/libs/Debug
mkdir $SDKARTIFACT/mac64_0/libs/Debug/lib3mf
mkdir $SDKARTIFACT/mac64_0/libs/Release
mkdir $SDKARTIFACT/mac64_0/libs/Release/lib3mf
mkdir $SDKARTIFACT/mac64_0/Frameworks
mkdir $SDKARTIFACT/mac64_0/Frameworks/Release
mkdir $SDKARTIFACT/mac64_0/Frameworks/Release/lib3mf

mkdir $SDKARTIFACT/linux_0
mkdir $SDKARTIFACT/linux_0/inc
mkdir $SDKARTIFACT/linux_0/lib


cp -r Autogenerated/Bindings/Cpp $SDKARTIFACT/win64_0/headers
cp -r Autogenerated/Bindings/CppDynamic $SDKARTIFACT/win64_0/headers

cp -r Autogenerated/Bindings/Cpp $SDKARTIFACT/mac64_0/headers
cp -r Autogenerated/Bindings/CppDynamic $SDKARTIFACT/mac64_0/headers

cp -r Autogenerated/Bindings/Cpp $SDKARTIFACT/linux_0/inc
cp -r Autogenerated/Bindings/CppDynamic $SDKARTIFACT/linux_0/inc


major_version=$(grep -oPm1 "(?<=lib3mf\"\sversion=\")[^.]+" AutomaticComponentToolkit/lib3mf.xml)

echo Copy binaries
cp $LOCATION/lib3mf.dll/lib3mf.dll $SDKARTIFACT/win64_0/libs/Release/lib3mf.$major_version.dll || failed "Error copying binary"
cp $LOCATION/lib3mf.lib/lib3mf.lib $SDKARTIFACT/win64_0/libs/Release/lib3mf.$major_version.lib || failed "Error copying binary"
cp $LOCATION/lib3mf.debug.dll/lib3mf.dll $SDKARTIFACT/win64_0/libs/Debug/lib3mf.$major_version.dll || failed "Error copying binary"
cp $LOCATION/lib3mf.debug.lib/lib3mf.lib $SDKARTIFACT/win64_0/libs/Debug/lib3mf.$major_version.lib || failed "Error copying binary"
cp $LOCATION/lib3mf.pdb/lib3mf.pdb $SDKARTIFACT/win64_0/libs/Debug/lib3mf.$major_version.pdb || failed "Error copying binary"
cp $LOCATION/lib3mf.dll/lib3mf.dll $SDKARTIFACT/win64_0/runtimeroots/Release/lib3mf.$major_version.dll || failed "Error copying binary"


cp $LOCATION/lib3mf.dylib/lib3mf.dylib $SDKARTIFACT/mac64_0/libs/Release/lib3mf/lib3mf.$major_version.dylib || failed "Error copying binary"
cp $LOCATION/lib3mf.debug.dylib/lib3mf.dylib $SDKARTIFACT/mac64_0/libs/Debug/lib3mf/lib3mf.$major_version.dylib || failed "Error copying binary"
cp $LOCATION/lib3mf.dylib/lib3mf.dylib $SDKARTIFACT/mac64_0/Frameworks/Release/lib3mf/lib3mf.$major_version.dylib || failed "Error copying binary"

cp $LOCATION/lib3mf.so/lib3mf.so.2 $SDKARTIFACT/linux_0/lib/lib3mf.$major_version.so || failed "Error copying binary"

echo Zip SDK artifacts
cd $SDKARTIFACT
cd win64_0
zip -r ../../win64_0.zip * || failed "Error zipping SDK"
cd ../mac64_0
zip -r ../../mac64_0.zip * || failed "Error zipping SDK"
cd ../linux_0
zip -r ../../linux_0.zip * || failed "Error zipping SDK"
cd ..